name: Render Quarto slides and deploy to GitHub Pages

on:
  push:
    # branches:
    #   - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  render-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Quarto CLI (pinned)
        env:
          QUARTO_VERSION: "1.8.25"   # <-- change this to the Quarto version you want, e.g. "1.5.0" or "latest-known"
        run: |
          echo "Installing Quarto CLI v${QUARTO_VERSION}"
          ARCH=linux-amd64
          FILE=quarto-${QUARTO_VERSION}-${ARCH}.deb
          URL="https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/${FILE}"
          echo "Downloading $URL"
          wget -q --show-progress "$URL" -O "/tmp/${FILE}"
          sudo dpkg -i "/tmp/${FILE}" || (sudo apt-get update && sudo apt-get -f install -y && sudo dpkg -i "/tmp/${FILE}")
          quarto --version

      - name: Render Quarto site
        run: |
          # If your repository is a Quarto site, render the whole site into _site
          mkdir -p _site
          # quarto render --output-dir _site
          # If you only render one file you can do:
          quarto render slides/comprepds/comp_rep_ds.qmd --to revealjs --output-dir _site
          ls -la _site

      - name: Setup Git for gh-pages commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          # Optionally set publish_branch: gh-pages (default is gh-pages)

      - name: Show expected Pages URL
        run: |
          owner="${{ github.repository_owner }}"
          repo_full="${{ github.repository }}"
          repo="${repo_full#*/}"
          owner_lower=$(echo "$owner" | tr '[:upper:]' '[:lower:]')
          echo "Expected Pages URL: https://${owner_lower}.github.io/${repo}/"
